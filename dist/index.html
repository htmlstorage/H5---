<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <title>{TAG_14226_TAG}</title>
  <!-- 页面的元信息 -->
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
  <meta name="format-detection" content="telephone=no, email=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="white" />
  <meta name="renderer" content="webkit" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="filetype" content="1" />
  <meta name="publishedtype" content="1" />
  <meta name="pagetype" content="2" />
  <meta name="screen-orientation" content="landscape" />
  <meta name="x5-orientation" content="landscape" />
  <meta name="full-screen" content="yes" />
  <meta name="x5-fullscreen" content="true" />
  <meta name="browsermode" content="application" />
  <meta name="x5-page-mode" content="app" />

  <!-- 页面主样式文件 -->
  <link charset="utf-8" rel="stylesheet" href="./static/css/owo.main.css">

  <!-- 附属css文件 -->
  <link rel="stylesheet" href="./static/css/main.css" charset="utf-8">

</head>

<body>
  <!-- 页面区域 -->
  <!-- 页面[login]-->
  <div class="home page" template="login" style="display: none;">
    <div class="lable">用户名</div>
    <input type="text" o-value="this.data.userName">
    <div class="lable">密码</div>
    <input type="password" o-value="this.data.passWord">
    <div class="button owo-hover-radial-out" o-tap="login">登录</div>
  </div>
  <!-- 页面[two]-->
  <div class="page-1 page" template="two" style="display: none;">
    <div class="title-bar">服务器列表</div>
    <div class="server-list-item" o-for="this.data.serverList" o-tap="toThree({key})">
      <div class="icon"></div>
      <div class="name">{value.url}</div>
    </div>
  </div>
  <!-- 页面[three]-->
  <div class="page-2 page" template="three" style="display: none;">
    <div class="title-bar">
      <div class="left" o-tap="window.history.back(-1)">
        <svg t="1554295944192" style="" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1970" xmlns:xlink="http://www.w3.org/1999/xlink">
          <path d="M721.226 845.716l-330.925-336.576 328.476-341.301c8.349-8.349 8.124-22.074-0.5-30.65l-59.175-59.175c-8.6-8.574-22.325-8.825-30.675-0.474l-334.326 347.4c-4.425 0.775-8.751 2.499-12.174 5.95l-59.775 59.75c-8.7 8.675-8.9 22.524-0.5 30.925l408.351 415.35c8.425 8.425 22.275 8.2 30.95-0.474l59.775-59.8c8.65-8.65 8.9-22.524 0.5-30.925z" p-id="1971"></path>
        </svg>
      </div>
      <span>进程列表</span>
    </div>
    <div class="process-list-box">
      <div class="process-list {value.statename}" o-for="this.data.processList">
        <div class="process-title-bar item">
          <div class="name">{value.name}</div>
          <div class="switch-run icon" o-tap="switchRun({key})">{value.state == '20' ? '' : ''}</div>
        </div>
        <div class="state item">运行状态: {value.statename}</div>
        <div class="time item">启动时间: {this.getLocalTime(value.start)}</div>
      </div>
    </div>
  </div>


  <script src="http://tools.people.com.cn/libs/jquery/1.11.1/jquery-1.11.1.min.js" type="text/javascript" charset="UTF-8"></script>
  <script src="./static/js/main.js" type="text/javascript" charset="UTF-8"></script>
  <script src="./static/js/xmlrpc.js" type="text/javascript" charset="UTF-8"></script>
  <!-- 框架script文件 -->
  <script src="./static/js/owo.main.js" type="text/javascript" charset="UTF-8"></script>
  <script>
    owo.script = {
      "login": {
        "data": {
          "userName": "puge",
          "passWord": "mmit7750"
        },
        "login": function login() {
          fetch("http://154.8.196.163:8006/login?username=" + this.data.userName + "&password=" + this.data.passWord + "&type=supervisor").then(function(response) {
            return response.json();
          }).then(function(res) {
            if (res.err === 0) {
              owo.tool.toast('登陆成功');
              if (res.data.data !== '') owo.script.two.data.serverList = JSON.parse(res.data.data);
              owo.go({
                page: 'two',
                ani: "moveToLeft/moveFromRight/moveToRight/moveFromLeft",
                noBack: true
              });
            }
          });
        }
      },
      "two": {
        "data": {
          "serverList": null
        },
        "created": function created() {
          var _this = this;

          console.log(this.data.serverList);

          if (this.data.serverList === null) {
            owo.go({
              page: 'login',
              ani: "moveToRight/moveFromLeft",
              noBack: true
            });
            return;
          } // 检测运行


          setTimeout(function() {
            var serverDomList = owo.query('.server-list-item');

            var _loop = function _loop(ind) {
              var element = _this.data.serverList[ind];
              xmlRpcClient("http://" + element.userName + ":" + element.passWord + "@" + element.url, "supervisor.getState", undefined, 'xml', function(err, data) {
                if (err) {
                  console.error(err);
                  return;
                }

                if (data.statecode == 1) {
                  element.state = true;
                  serverDomList[ind].classList.add('active');
                }
              });
            };

            for (var ind in _this.data.serverList) {
              _loop(ind);
            }
          }, 0);
        },
        "toThree": function toThree(ind) {
          owo.script.three.data.serverInfo = this.data.serverList[ind];
          owo.go({
            page: 'three',
            ani: "moveToLeft/moveFromRight/moveToRight/moveFromLeft",
            noBack: true
          });
        }
      },
      "three": {
        "data": {
          "serverInfo": null,
          "processList": [],
          "serverUrl": ""
        },
        "show": function show() {
          var _this2 = this;

          if (this.data.serverInfo === null) {
            owo.go({
              page: 'login',
              ani: "moveToRight/moveFromLeft",
              noBack: true
            });
            return;
          }

          this.data.serverUrl = "http://" + this.data.serverInfo.userName + ":" + this.data.serverInfo.passWord + "@" + this.data.serverInfo.url;
          xmlRpcClient(this.data.serverUrl, "supervisor.getAllProcessInfo", undefined, 'xml', function(err, data) {
            if (err) {
              console.error(err);
              return;
            }

            console.log(data);
            _this2.data.processList = data;

            _this2.handleEvent();
          });
        },
        "getLocalTime": function getLocalTime(nS) {
          return new Date(parseInt(nS) * 1000).toLocaleString().replace(/:\\d{1,2}$/, ' ');
        },
        "switchRun": function switchRun(key) {
          var _this3 = this;

          var item = this.data.processList[key];
          console.log(this.data.processList[key]);
          var command = 'supervisor.startProcess';

          if (item.state == '20') {
            command = "supervisor.stopProcess";
          }

          xmlRpcClient(this.data.serverUrl, command, item.name, 'xml', function(err, data) {
            if (err) {
              console.error(err);
              return;
            }

            owo.tool.toast('操作成功!');

            _this3.show();
          });
        },
        "restart": function restart() {
          var _this4 = this;

          xmlRpcClient(this.data.serverUrl, command, item.name, 'xml', function(err, data) {
            if (err) {
              console.error(err);
              return;
            }

            owo.tool.toast('操作成功!');

            _this4.show();
          });
        },
        "template": {}
      }
    };
  </script>
</body>

</html>